flowchart TD
    Start(["開始"]) --> DBConnect["DB接続 (pg_connect)"]
    
    %% DB接続判定
    DBConnect --> IsDBConnected{"接続成功?"}
    IsDBConnected -- "No" --> CheckErrType{"リクエストは<br>POST または Ajaxか?"}
    CheckErrType -- "Yes" --> Res500["JSON 500 Error"] --> End(["終了"])
    CheckErrType -- "No" --> ResText["Text Error Message"] --> End
    
    IsDBConnected -- "Yes" --> CheckAuthLogic

    %% トークン認証ロジック
    subgraph Auth ["トークン認証"]
        CheckAuthLogic{"リクエストは<br>GET かつ Ajaxではない ?"}
        CheckAuthLogic -- "Yes" --> CheckTokenParam{"URLのパラメーターに<br>トークンがある?"}
        CheckTokenParam -- "No" --> Res403_1["403 Token Required"] --> End
        CheckTokenParam -- "Yes" --> ReadTokenFile["トークンファイル読み込み"]
        ReadTokenFile --> VerifyToken{"トークンが 一致 かつ<br>有効期限内 か?"}
        VerifyToken -- "No" --> Res403_2["403 Invalid/Expired"] --> End
        VerifyToken -- "Yes" --> NextStep
    end
    
    CheckAuthLogic -- "No (POST or Ajax)" --> NextStep["リクエスト種別判定へ"]

    %% リクエスト分岐
    %%NextStep --> IsPost{"Method == POST?"}
    NextStep --> IsPost{"リクエストはPOSTか?"}

    %% POST処理 (データ登録)
    IsPost -- "Yes" --> DecodeJSON["JSON入力デコード"]
    %% DecodeJSON --> CheckParams{"必須項目あり?"}
    DecodeJSON --> CheckParams{"データが揃っているか?"}
    
    CheckParams -- "No" --> Res400["400 Error JSON"] --> End
    CheckParams -- "Yes" --> InsertDB["INSERT sensor_logs"]
    
    InsertDB --> IsInsertSuccess{"INSERT成功?"}
    IsInsertSuccess -- "Yes" --> ResSuccess["JSON OK"] --> End
    IsInsertSuccess -- "No" --> Res500Ins["500 Error JSON"] --> End

    %% AJAX処理 (データ取得API)
    %% IsPost -- "No" --> IsAjax{"GET param 'ajax' あり?"}
    IsPost -- "No" --> IsAjax{"GETパラメータはajaxであるか?"}
    
    IsAjax -- "Yes" --> GetRoomID["URLパラメータより<br>room_id取得"]
    GetRoomID --> IfGetRoomID_Null{"room_idはnull以外か？"}
    IfGetRoomID_Null -- "No"--> BuildQueryHTML
    %% GetRoomID --> BuildQueryAjax["クエリ作成<br/>WHERE room_id"]
    IfGetRoomID_Null -- "Yes" --> BuildQueryAjax["クエリ作成<br>部屋は"room_id]
    BuildQueryAjax --> ExecQueryAjax["DB検索 SELECT"]
    ExecQueryAjax --> FetchRowsAjax["結果を配列に格納"]
    FetchRowsAjax --> ResJSON["JSONデータを出力"] --> End

    %% HTML描画処理 (初期表示)
    IsAjax -- "No" --> BuildQueryHTML["クエリ作成<br/>最新10件"]
    BuildQueryHTML --> ExecQueryHTML["DB検索 SELECT"]
    ExecQueryHTML --> FetchRowsHTML["結果を配列に格納"]
    FetchRowsHTML --> RenderHTML["HTMLページ描画<br/>(Table, JS含む)"] --> End